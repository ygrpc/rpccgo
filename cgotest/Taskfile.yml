version: '3'

tasks:
  check-deps:
    internal: true
    desc: Check if required dependencies are installed
    cmds:
      - |
        #!/usr/bin/env bash
        set -e
        missing=""
        for cmd in protoc protoc-gen-go protoc-gen-go-grpc protoc-gen-connect-go protoc-gen-rpc-cgo-adaptor protoc-gen-rpc-cgo; do
          if ! command -v "$cmd" >/dev/null 2>&1; then
            missing="$missing"$'\n'"  - $cmd"
          fi
        done
        if [ -n "$missing" ]; then
          echo "❌ Missing required dependencies:$missing"
          echo ""
          echo "Install with:"
          echo "  go install google.golang.org/protobuf/cmd/protoc-gen-go@latest"
          echo "  go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest"
          echo "  go install connectrpc.com/connect/cmd/protoc-gen-connect-go@latest"
          echo "  go install github.com/ygrpc/rpccgo/cmd/protoc-gen-rpc-cgo-adaptor@latest"
          echo "  go install github.com/ygrpc/rpccgo/cmd/protoc-gen-rpc-cgo@latest"
          exit 1
        fi

  build:grpc:
    internal: true
    desc: Build adaptor code for gRPC protocol
    cmds:
      - |
        #!/bin/env bash

        set -euo pipefail

        cd "$(dirname "$0")/"

        if ! command -v protoc >/dev/null 2>&1; then
            echo "protoc is not installed. Please install Protocol Buffers compiler."
            exit 1
        fi

        if ! command -v protoc-gen-go >/dev/null 2>&1; then
            go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        fi

        if ! command -v protoc-gen-go-grpc >/dev/null 2>&1; then
            go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
        fi

        echo "Installing protoc-gen-rpc-cgo-adaptor (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo-adaptor)

        mkdir -p ./grpc
        # Clean generated files but keep hand-written tests.
        find ./grpc -mindepth 1 -maxdepth 1 -type f ! -name 'adaptor_test.go' -delete
        find ./grpc -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+'

        # Package mapping for cgotest_grpc
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/grpc;cgotest_grpc,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/grpc;cgotest_grpc"

        protoc  -Iproto -I../proto --go_out=./grpc --go_opt=paths=source_relative,${GO_PKG} \
         --go-grpc_out=./grpc --go-grpc_opt=paths=source_relative,${GO_PKG} \
         ./proto/unary.proto ./proto/stream.proto

         protoc -Iproto -I../proto --rpc-cgo-adaptor_out=./grpc \
          --rpc-cgo-adaptor_opt=paths=source_relative,protocol=grpc,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto

  build:connect:
    desc: Build adaptor code for ConnectRPC protocol
    cmds:
      - |
        #!/bin/env bash

        set -euo pipefail

        cd "$(dirname "$0")/"

        if ! command -v protoc >/dev/null 2>&1; then
            echo "protoc is not installed. Please install Protocol Buffers compiler."
            exit 1
        fi

        if ! command -v protoc-gen-go >/dev/null 2>&1; then
            go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        fi

        if ! command -v protoc-gen-connect-go >/dev/null 2>&1; then
            go install connectrpc.com/connect/cmd/protoc-gen-connect-go@v1.19.0
        fi

        if ! protoc-gen-connect-go --version | grep -q "v1.19.0"; then
            go install connectrpc.com/connect/cmd/protoc-gen-connect-go@v1.19.0
        fi

        echo "Installing protoc-gen-rpc-cgo-adaptor (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo-adaptor)

        mkdir -p ./connect
        # Clean generated files but keep hand-written tests.
        find ./connect -mindepth 1 -maxdepth 1 -type f ! -name 'adaptor_test.go' -delete
        find ./connect -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+'

        # Package mapping for cgotest_connect
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/connect;cgotest_connect,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/connect;cgotest_connect"

         protoc  -Iproto -I../proto --go_out=./connect --go_opt=paths=source_relative,${GO_PKG} \
          --connect-go_out=./connect --connect-go_opt=package_suffix="",paths=source_relative,simple=true,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto

         protoc -Iproto -I../proto --rpc-cgo-adaptor_out=./connect \
          --rpc-cgo-adaptor_opt=paths=source_relative,protocol=connectrpc,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto

  build:mix:
    internal: true
    desc: Build adaptor code for multi-protocol (grpc|connectrpc) with fallback
    cmds:
      - |
        #!/bin/env bash

        set -euo pipefail

        cd "$(dirname "$0")/"

        if ! command -v protoc >/dev/null 2>&1; then
            echo "protoc is not installed. Please install Protocol Buffers compiler."
            exit 1
        fi

        echo "Installing protoc-gen-rpc-cgo-adaptor (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo-adaptor)

        mkdir -p ./mix
        # Clean generated files but keep hand-written tests.
        find ./mix -mindepth 1 -maxdepth 1 -type f ! -name 'adaptor_test.go' -delete
        find ./mix -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+'

        # Package mapping for cgotest_mix
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/mix;cgotest_mix,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/mix;cgotest_mix"

        protoc -Iproto -I../proto \
          --go_out=./mix --go_opt=paths=source_relative,${GO_PKG} \
          --go-grpc_out=./mix --go-grpc_opt=paths=source_relative,${GO_PKG} \
          --connect-go_out=./mix --connect-go_opt=paths=source_relative,simple=true,${GO_PKG} \
          --rpc-cgo-adaptor_out=./mix \
          --rpc-cgo-adaptor_opt=paths=source_relative,"protocol=grpc|connectrpc",${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto

  build:connect_suffix:
    internal: true
    desc: Build adaptor code for ConnectRPC protocol with suffix package
    cmds:
      - |
        #!/bin/env bash

        set -euo pipefail

        cd "$(dirname "$0")/"

        if ! command -v protoc >/dev/null 2>&1; then
            echo "protoc is not installed. Please install Protocol Buffers compiler."
            exit 1
        fi

        if ! command -v protoc-gen-go >/dev/null 2>&1; then
            go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        fi

        if ! command -v protoc-gen-connect-go >/dev/null 2>&1; then
            go install connectrpc.com/connect/cmd/protoc-gen-connect-go@v1.19.0
        fi

        if ! protoc-gen-connect-go --version | grep -q "v1.19.0"; then
            go install connectrpc.com/connect/cmd/protoc-gen-connect-go@v1.19.0
        fi

        echo "Installing protoc-gen-rpc-cgo-adaptor (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo-adaptor)

        mkdir -p ./connect_suffix
        # Clean generated files but keep hand-written tests.
        find ./connect_suffix -mindepth 1 -maxdepth 1 -type f ! -name 'adaptor_test.go' -delete
        find ./connect_suffix -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+'

        # Package mapping for cgotest_connect_suffix
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/connect_suffix;cgotest_connect_suffix,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/connect_suffix;cgotest_connect_suffix"

        protoc -Iproto -I../proto \
          --go_out=./connect_suffix --go_opt=paths=source_relative,${GO_PKG} \
          --connect-go_out=./connect_suffix --connect-go_opt=paths=source_relative,simple=true,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto

        protoc -Iproto -I../proto --rpc-cgo-adaptor_out=./connect_suffix \
          --rpc-cgo-adaptor_opt=paths=source_relative,protocol=connectrpc,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto

  adaptor-test:grpc:
    internal: true
    desc: Run Go adaptor test for gRPC
    deps: [build:grpc]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        echo ">>> Testing gRPC..."
        (cd ./grpc && go test -v ./)

  adaptor-test:connect:
    internal: true
    desc: Run Go adaptor test for ConnectRPC
    deps: [build:connect]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        echo ">>> Testing ConnectRPC..."
        (cd ./connect && go test -v ./)

  adaptor-test:mix:
    internal: true
    desc: Run Go adaptor test for multi-protocol
    deps: [build:mix]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        echo ">>> Testing mix (grpc+connectrpc)..."
        (cd ./mix && go test -v ./)

  adaptor-test:connect_suffix:
    internal: true
    desc: Run Go adaptor test for ConnectRPC with suffix
    deps: [build:connect_suffix]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        echo ">>> Testing connect_suffix (connectrpc)..."
        (cd ./connect_suffix && go test -v ./)

  adaptor-test:all:
    internal: true
    desc: Run all Go adaptor tests
    cmds:
      - task: adaptor-test:connect
      - task: adaptor-test:grpc
      - task: adaptor-test:mix
      - task: adaptor-test:connect_suffix
      - echo "=== All adaptor tests completed ==="

  adaptor-test:
    desc: Run adaptor tests (default all, or specify grpc|connect|mix|connect_suffix)
    deps: ['adaptor-test:{{.PROTOCOL}}']
    vars:
      PROTOCOL: '{{.PROTOCOL | default "all"}}'
    preconditions:
      - sh: bash -c '[[ "{{.PROTOCOL}}" =~ ^(all|grpc|connect|mix|connect_suffix)$ ]]'
        msg: 'Invalid PROTOCOL "{{.PROTOCOL}}". Must be one of: all, grpc, connect, mix, connect_suffix'

  c-test:grpc:
    internal: true
    desc: Run C end-to-end tests for gRPC
    deps: [build-cgo:grpc]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        cc_bin="${CC:-cc}"
        cflags=(-O2 -std=c11 -Wall -Wextra -D_POSIX_C_SOURCE=200809L -I./c_tests)
        ldflags=(-L./c_tests -lygrpc -Wl,-rpath,'$ORIGIN')
        
        echo "Building C tests (grpc)..."
        "${cc_bin}" "${cflags[@]}" ./c_tests/unary_test.c -o ./c_tests/unary_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/client_stream_test.c -o ./c_tests/client_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/server_stream_test.c -o ./c_tests/server_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/bidi_stream_test.c -o ./c_tests/bidi_stream_test "${ldflags[@]}"
        
        echo "Running C tests (grpc)..."
        (cd ./c_tests && ./unary_test && ./client_stream_test && ./server_stream_test && ./bidi_stream_test)
        echo "C tests OK (grpc)"

  c-test:connect:
    internal: true
    desc: Run C end-to-end tests for ConnectRPC
    deps: [build-cgo:connect]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        cc_bin="${CC:-cc}"
        cflags=(-O2 -std=c11 -Wall -Wextra -D_POSIX_C_SOURCE=200809L -I./c_tests)
        ldflags=(-L./c_tests -lygrpc -Wl,-rpath,'$ORIGIN')
        
        echo "Building C tests (connect)..."
        "${cc_bin}" "${cflags[@]}" ./c_tests/unary_test.c -o ./c_tests/unary_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/client_stream_test.c -o ./c_tests/client_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/server_stream_test.c -o ./c_tests/server_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/bidi_stream_test.c -o ./c_tests/bidi_stream_test "${ldflags[@]}"
        
        echo "Running C tests (connect)..."
        (cd ./c_tests && ./unary_test && ./client_stream_test && ./server_stream_test && ./bidi_stream_test)
        echo "C tests OK (connect)"

  c-test:mix:
    internal: true
    desc: Run C end-to-end tests for multi-protocol
    deps: [build-cgo:mix]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        cc_bin="${CC:-cc}"
        cflags=(-O2 -std=c11 -Wall -Wextra -D_POSIX_C_SOURCE=200809L -I./c_tests)
        ldflags=(-L./c_tests -lygrpc -Wl,-rpath,'$ORIGIN')
        
        echo "Building C tests (mix)..."
        "${cc_bin}" "${cflags[@]}" ./c_tests/unary_test.c -o ./c_tests/unary_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/client_stream_test.c -o ./c_tests/client_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/server_stream_test.c -o ./c_tests/server_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/bidi_stream_test.c -o ./c_tests/bidi_stream_test "${ldflags[@]}"
        
        echo "Running C tests (mix)..."
        (cd ./c_tests && ./unary_test && ./client_stream_test && ./server_stream_test && ./bidi_stream_test)
        echo "C tests OK (mix)"

  c-test:connect_suffix:
    internal: true
    desc: Run C end-to-end tests for ConnectRPC with suffix
    deps: [build-cgo:connect_suffix]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        cc_bin="${CC:-cc}"
        cflags=(-O2 -std=c11 -Wall -Wextra -D_POSIX_C_SOURCE=200809L -I./c_tests)
        ldflags=(-L./c_tests -lygrpc -Wl,-rpath,'$ORIGIN')
        
        echo "Building C tests (connect_suffix)..."
        "${cc_bin}" "${cflags[@]}" ./c_tests/unary_test.c -o ./c_tests/unary_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/client_stream_test.c -o ./c_tests/client_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/server_stream_test.c -o ./c_tests/server_stream_test "${ldflags[@]}"
        "${cc_bin}" "${cflags[@]}" ./c_tests/bidi_stream_test.c -o ./c_tests/bidi_stream_test "${ldflags[@]}"
        
        echo "Running C tests (connect_suffix)..."
        (cd ./c_tests && ./unary_test && ./client_stream_test && ./server_stream_test && ./bidi_stream_test)
        echo "C tests OK (connect_suffix)"

  c-test:all:
    internal: true
    desc: Run all C end-to-end tests
    cmds:
      - task: c-test:connect
      - echo ""
      - task: c-test:grpc
      - echo ""
      - task: c-test:mix
      - echo ""
      - task: c-test:connect_suffix

  c-test:
    desc: Run C end-to-end tests (default all, or specify grpc|connect|mix|connect_suffix)
    deps: ['c-test:{{.PROTOCOL}}']
    vars:
      PROTOCOL: '{{.PROTOCOL | default "all"}}'
    preconditions:
      - sh: bash -c '[[ "{{.PROTOCOL}}" =~ ^(all|grpc|connect|mix|connect_suffix)$ ]]'
        msg: 'Invalid PROTOCOL "{{.PROTOCOL}}". Must be one of: all, grpc, connect, mix, connect_suffix'

  test:
    desc: Run full test suite (adaptor + C tests)
    cmds:
      - task: adaptor-test:all
      - echo ""
      - echo "=== Running C end-to-end tests ==="
      - task: c-test:all
      - echo ""
      - echo "=== All tests completed ==="

  build:
    desc: Build adaptor code for protocol (default connect, or specify grpc|connect|mix|connect_suffix)
    deps: ['build:{{.PROTOCOL}}']
    vars:
      PROTOCOL: '{{.PROTOCOL | default "connect"}}'
    preconditions:
      - sh: bash -c '[[ "{{.PROTOCOL}}" =~ ^(grpc|connect|mix|connect_suffix)$ ]]'
        msg: 'Invalid PROTOCOL "{{.PROTOCOL}}". Must be one of: grpc, connect, mix, connect_suffix'

  build-cgo:grpc:
    internal: true
    desc: Build C ABI export for gRPC protocol
    deps: [build:grpc]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        echo "Installing protoc-gen-rpc-cgo (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo)
        
        mkdir -p ./cgo_grpc
        find ./cgo_grpc -mindepth 1 -maxdepth 1 -type f ! -name 'registry.go' -delete
        find ./cgo_grpc -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+' 2>/dev/null || true
        
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/grpc;cgotest_grpc,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/grpc;cgotest_grpc"
        
        protoc -Iproto -I../proto \
          --rpc-cgo_out=./cgo_grpc \
          --rpc-cgo_opt=paths=source_relative,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto
        
        echo "Building c-shared library (grpc)..."
        go build -buildmode=c-shared -o ./c_tests/libygrpc.so ./cgo_grpc
        cp ./cgo_grpc/ygrpc_cgo_common.h ./c_tests/

  build-cgo:connect:
    internal: true
    desc: Build C ABI export for ConnectRPC protocol
    deps: [build:connect]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        echo "Installing protoc-gen-rpc-cgo (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo)
        
        mkdir -p ./cgo_connect
        find ./cgo_connect -mindepth 1 -maxdepth 1 -type f ! -name 'registry.go' -delete
        find ./cgo_connect -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+' 2>/dev/null || true
        
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/connect;cgotest_connect,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/connect;cgotest_connect"
        
        protoc -Iproto -I../proto \
          --rpc-cgo_out=./cgo_connect \
          --rpc-cgo_opt=paths=source_relative,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto
        
        echo "Building c-shared library (connect)..."
        go build -buildmode=c-shared -o ./c_tests/libygrpc.so ./cgo_connect
        cp ./cgo_connect/ygrpc_cgo_common.h ./c_tests/

  build-cgo:mix:
    internal: true
    desc: Build C ABI export for multi-protocol
    deps: [build:mix]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        echo "Installing protoc-gen-rpc-cgo (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo)
        
        mkdir -p ./cgo_mix
        find ./cgo_mix -mindepth 1 -maxdepth 1 -type f ! -name 'registry.go' -delete
        find ./cgo_mix -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+' 2>/dev/null || true
        
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/mix;cgotest_mix,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/mix;cgotest_mix"
        
        protoc -Iproto -I../proto \
          --rpc-cgo_out=./cgo_mix \
          --rpc-cgo_opt=paths=source_relative,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto
        
        echo "Building c-shared library (mix)..."
        go build -buildmode=c-shared -o ./c_tests/libygrpc.so ./cgo_mix
        cp ./cgo_mix/ygrpc_cgo_common.h ./c_tests/

  build-cgo:connect_suffix:
    internal: true
    desc: Build C ABI export for ConnectRPC with suffix
    deps: [build:connect_suffix]
    cmds:
      - |
        #!/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")/"
        
        echo "Installing protoc-gen-rpc-cgo (from workspace)..."
        (cd .. && go install ./cmd/protoc-gen-rpc-cgo)
        
        mkdir -p ./cgo_connect_suffix
        find ./cgo_connect_suffix -mindepth 1 -maxdepth 1 -type f ! -name 'registry.go' -delete
        find ./cgo_connect_suffix -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' '+' 2>/dev/null || true
        
        GO_PKG="Munary.proto=github.com/ygrpc/rpccgo/cgotest/connect_suffix;cgotest_connect_suffix,Mstream.proto=github.com/ygrpc/rpccgo/cgotest/connect_suffix;cgotest_connect_suffix"
        
        protoc -Iproto -I../proto \
          --rpc-cgo_out=./cgo_connect_suffix \
          --rpc-cgo_opt=paths=source_relative,${GO_PKG} \
          ./proto/unary.proto ./proto/stream.proto
        
        echo "Building c-shared library (connect_suffix)..."
        go build -buildmode=c-shared -o ./c_tests/libygrpc.so ./cgo_connect_suffix
        cp ./cgo_connect_suffix/ygrpc_cgo_common.h ./c_tests/

  build-cgo:
    desc: Build C ABI export for protocol (default connect, or specify grpc|connect|mix|connect_suffix)
    deps: ['build-cgo:{{.PROTOCOL}}']
    vars:
      PROTOCOL: '{{.PROTOCOL | default "connect"}}'
    preconditions:
      - sh: bash -c '[[ "{{.PROTOCOL}}" =~ ^(grpc|connect|mix|connect_suffix)$ ]]'
        msg: 'Invalid PROTOCOL "{{.PROTOCOL}}". Must be one of: grpc, connect, mix, connect_suffix'

  clean:
    desc: Clean build artifacts (generated code, .so, .h files) but keep hand-written tests
    cmds:
      - |
        #!/usr/bin/env bash
        set -e
        echo "Cleaning build artifacts..."
        for protocol in grpc connect mix connect_suffix; do
            echo "  Cleaning $protocol..."
            find ./$protocol -mindepth 1 -maxdepth 1 -type f ! -name 'adaptor_test.go' -delete 2>/dev/null || true
            find ./$protocol -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' + 2>/dev/null || true
            find ./cgo_$protocol -mindepth 1 -maxdepth 1 -type f ! -name 'registry.go' -delete 2>/dev/null || true
            find ./cgo_$protocol -mindepth 1 -maxdepth 1 -type d -exec rm -rf '{}' + 2>/dev/null || true
        done
        echo "  Cleaning c_tests artifacts..."
        rm -f ./c_tests/libygrpc.so ./c_tests/libygrpc.h ./c_tests/ygrpc_cgo_common.h
        echo "✓ Clean completed"

  install-plugins:
    desc: Install required protoc plugins (from workspace root)
    cmds:
      - echo "Installing protoc plugins..."
      - go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
      - go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
      - go install connectrpc.com/connect/cmd/protoc-gen-connect-go@latest
      - (cd .. && go install ./cmd/protoc-gen-rpc-cgo-adaptor)
      - (cd .. && go install ./cmd/protoc-gen-rpc-cgo)
      - echo "✓ All plugins installed"

  regen:
    desc: Regenerate code for all protocols (grpc, connect, mix, connect_suffix)
    deps: [check-deps]
    cmds:
      - |
        #!/usr/bin/env bash
        set -e
        echo "Regenerating all protocol variants..."
        for protocol in grpc connect mix connect_suffix; do
            echo ""
            echo ">>> Generating $protocol..."
            task build PROTOCOL=$protocol
            echo ">>> Building C ABI for $protocol..."
            task build-cgo PROTOCOL=$protocol
        done
        echo ""
        echo "✓ All protocols regenerated"
